
# Final testing phase
- name: Deploy a pod with aidamian/llm_api image
  k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Pod
      metadata:
        name: llm-api-test-pod
        labels:
          app: llm-api-test
      spec:
        containers:
          - name: llm-api
            image: aidamian/llm_api
            ports:
              - containerPort: 5060
            resources:
              limits:
                nvidia.com/gpu: 1 # Requesting one GPU

- name: Expose the pod through a service
  k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Service
      metadata:
        name: llm-api-test-service
      spec:
        selector:
          app: llm-api-test
        ports:
          - protocol: TCP
            port: 5060
            targetPort: 5060

- name: Wait for the service to be up
  wait_for:
    port: 5060
    delay: 10
    timeout: 60
  delegate_to: localhost

- name: Send a request to the API
  uri:
    url: "http://{{ hostvars['kube_masters']['ansible_host'] }}:5060/predict/"
    method: POST
    body: '{"text": "Tu esti cam f.r.a.i.e.r"}'
    body_format: json
    return_content: yes
    status_code: 200
    headers:
      Content-Type: "application/json"
  register: api_response
  delegate_to: localhost

- name: Display API response
  debug:
    msg: "{{ api_response.json }}"

- name: Assert that CUDA is being used
  assert:
    that:
      - "'cuda' in api_response.json['metadata']['device']"
    fail_msg: "CUDA is not being used in the response"
    success_msg: "CUDA is being used in the response"

- name: Delete test pod
  k8s:
    state: absent
    definition:
      apiVersion: v1
      kind: Pod
      metadata:
        name: llm-api-test-pod

- name: Delete test service
  k8s:
    state: absent
    definition:
      apiVersion: v1
      kind: Service
      metadata:
        name: llm-api-test-service

- name: Wait for pod deletion
  k8s_info:
    api_version: v1
    kind: Pod
    name: llm-api-test-pod
  register: pod
  until: pod.resources | length == 0
  retries: 5
  delay: 10

- name: Wait for service deletion
  k8s_info:
    api_version: v1
    kind: Service
    name: llm-api-test-service
  register: service
  until: service.resources | length == 0
  retries: 5
  delay: 10
